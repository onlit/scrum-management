image: docker:20.10.16

variables:
  BASE_IMAGE: $CI_REGISTRY_IMAGE/web

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DOCKERFILE: "Dockerfile.prod"
        IMAGE_TAG: "prod-amd64"
    - if: '$CI_COMMIT_BRANCH == "staging"'
      variables:
        DOCKERFILE: "Dockerfile.staging"
        IMAGE_TAG: "staging-amd64"
    - if: '$CI_COMMIT_BRANCH == "dev"'
      variables:
        DOCKERFILE: "Dockerfile.dev"
        IMAGE_TAG: "dev-amd64"

stages:
  - build

before_script:
  - apk add --no-cache --update curl
  - |
    echo "Waiting for Docker daemon..."
    for i in $(seq 1 60); do
        docker info > /dev/null 2>&1 && echo "Docker daemon is ready." && break
        if [ $i -eq 60 ]; then
            echo "Timeout: Docker daemon not ready after 60s."
            exit 1
        fi
        sleep 1s
    done
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_JOB_TOKEN" "$CI_REGISTRY"
  - |
    if [ -n "$DOCKER_HUB_USERNAME" ] && [ -n "$DOCKER_HUB_TOKEN" ]; then
      echo "Logging into secondary registry as $DOCKER_HUB_USERNAME..."
      echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin docker.io
    else
      echo "Skipping login to secondary registry: DOCKER_HUB_USERNAME or DOCKER_HUB_TOKEN not set."
    fi

build_amd64:
  stage: build
  tags:
    - k8s
  script:
    - export AMD64_CONTAINER_IMAGE="$BASE_IMAGE:$IMAGE_TAG"
    - docker pull "$AMD64_CONTAINER_IMAGE" || echo "Cache image pull failed or image does not exist, proceeding with build."
    - |
      echo "Building Docker image..."
      docker build \
        --cache-from "$AMD64_CONTAINER_IMAGE" \
        -t "$AMD64_CONTAINER_IMAGE" \
        -f "$DOCKERFILE" .
    - docker push "$AMD64_CONTAINER_IMAGE"
    - |
      if [ -n "$PIPELINE_TRIGGER_TOKEN" ] && [ -n "$TARGET_PROJECT_ID" ]; then
        echo "Triggering downstream pipeline for project $TARGET_PROJECT_ID..."
        curl --fail -X POST \
          --form token="$PIPELINE_TRIGGER_TOKEN" \
          --form ref="$CI_COMMIT_BRANCH" \
          --form "variables[TRIGGERED_BY_PIPELINE_URL]=$CI_PIPELINE_URL" \
          --form "variables[TRIGGER_IMAGE_TAG]=$CI_COMMIT_SHA" \
          --form "variables[TRIGGER]=true" \
          "https://git.pullstream.com/api/v4/projects/$TARGET_PROJECT_ID/trigger/pipeline"
      else
        echo "Skipping downstream pipeline trigger: PIPELINE_TRIGGER_TOKEN or TARGET_PROJECT_ID not set."
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "staging" || $CI_COMMIT_BRANCH == "dev"'
