apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{MICROSERVICE_SLUG}}-pgbouncer
  namespace: prod
  labels:
    app: {{MICROSERVICE_SLUG}}-pgbouncer
    devOps: {{MICROSERVICE_SLUG}}-k8s
spec:
  replicas: 1
  revisionHistoryLimit: 10
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: {{MICROSERVICE_SLUG}}-pgbouncer
  template:
    metadata:
      labels:
        app: {{MICROSERVICE_SLUG}}-pgbouncer
    spec:
      terminationGracePeriodSeconds: 45
      nodeSelector:
        performance: fast
      containers:
        - name: pgbouncer
          image: edoburu/pgbouncer:v1.24.1-p1
          ports:
            - name: pgbouncer
              containerPort: 5432
          securityContext:
            runAsUser: 100
            runAsGroup: 100
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          envFrom:
            - secretRef: { name: {{MICROSERVICE_SLUG}}-pgbouncer-secret }
            - configMapRef: { name: {{MICROSERVICE_SLUG}}-pgbouncer-configmap }
          readinessProbe:
            tcpSocket: { port: 5432 }
            periodSeconds: 10
          livenessProbe:
            tcpSocket: { port: 5432 }
            periodSeconds: 60
          lifecycle:
            preStop:
              exec:
                # Graceful drain: signal PgBouncer PID 1, then wait
                command: ["/bin/sh", "-c", "kill -INT 1; sleep 30"]
          resources:
            requests:
              cpu: "150m"
              memory: "128Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"
          volumeMounts:
            - name: pgbouncer-config
              mountPath: /etc/pgbouncer/pgbouncer.ini
              subPath: pgbouncer.ini
            - name: pgbouncer-userlist-config
              mountPath: /etc/pgbouncer/userlist.txt
              subPath: userlist.txt
            - name: pgbouncer-tmp
              mountPath: /tmp
      imagePullSecrets:
        - name: ps-gitlab-registry-secret
      volumes:
        - name: pgbouncer-tmp
          emptyDir: {}
        - name: pgbouncer-config
          configMap:
            name: {{MICROSERVICE_SLUG}}-pgbouncer-configmap
            items:
              - key: pgbouncer.ini
                path: pgbouncer.ini
        - name: pgbouncer-userlist-config
          secret:
            secretName: {{MICROSERVICE_SLUG}}-pgbouncer-secret
            items:
              - key: userlist.txt
                path: userlist.txt
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{MICROSERVICE_SLUG}}-pgbouncer-pdb
  namespace: prod
  labels:
    devOps: {{MICROSERVICE_SLUG}}-k8s
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: {{MICROSERVICE_SLUG}}-pgbouncer
---
apiVersion: v1
kind: Service
metadata:
  name: {{MICROSERVICE_SLUG}}-pgbouncer-svc
  namespace: prod
  labels:
    devOps: {{MICROSERVICE_SLUG}}-k8s
spec:
  selector:
    app: {{MICROSERVICE_SLUG}}-pgbouncer
  ports:
    - name: pgbouncer
      port: 5432
      targetPort: 5432
